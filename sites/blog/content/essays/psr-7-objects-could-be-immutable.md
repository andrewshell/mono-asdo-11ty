---
title: PSR-7 Objects Could Be Immutable
date: 2016-12-31T14:58:01.000Z
updated: 2016-12-31T14:58:01.000Z
published: true
---

I've been thinking a lot about immutable objects lately. Yegor Bugayenko claims that [Objects Should Be Immutable](http://www.yegor256.com/2014/06/09/objects-should-be-immutable.html) and [PSR-7: HTTP message interfaces](http://www.php-fig.org/psr/psr-7/) are [designed to be immutable](http://www.php-fig.org/psr/psr-7/meta/#why-value-objects).

> Messages are values where the identity is the aggregate of all parts of the message; a change to any aspect of the message is essentially a new message. This is the very definition of a value object. The practice by which changes result in a new instance is termed immutability and is a feature designed to ensure the integrity of a given value.

There has been some discussion around the [mutability of streams in PSR-7](http://www.php-fig.org/psr/psr-7/meta/#why-are-streams-mutable).

Andrew Carter wrote a post discussing why [PSR-7 Objects Are Not Immutable](http://andrewcarteruk.github.io/programming/2016/05/22/psr-7-is-not-immutable.html) saying:

> You shouldnâ€™t expect to see the message that was written to the response actually rendered. The code we have written explicitly avoided returning the response by throwing the exception. However, if you disable the Whoops error handler and use the default templated error handler you will find that your message still appears at the top of the error page that is generated by the framework.

Paul M. Jones mentions the immutability of streams in [Avoiding Quasi-Immutable Objects in PHP](http://paul-m-jones.com/archives/6400).

> If a stream or similar resource has been opened in a writable (or appendable) mode, and is used as an immutable property, it should be obvious that object immutability is not preserved.

This makes sense. If you write to a stream, then rewind it and write it, the value has changed.

**I don't think this makes the class wrapping the stream mutable.**

Yegor talks about this idea in [Gradients of Immutability](http://www.yegor256.com/2016/09/07/gradients-of-immutability.html).

His argument would be that the object isn't a constant, but it is immutable.

The object isn't representative of the content of the stream, but of the reference to the stream.

It's like if you had an object that interacted with a file.

```php
class File {
  private $filename;
  public function __construct($filename) {
  }
  public function read() {
  }
  public function write($data) {
  }
}
$f = new File(__DIR__ . '/test.txt');
$f->write('hoopla');
$g = clone $f;
$g->write('ballyhoo');
// Prints 'ballyhoo'
echo $f->read();
```

You might argue that a `File` object isn't immutable because if it was `$f->read()` should have returned "hoopla". But I disagree.

The File object is wrapping a file name, a pointer to a file in the file system. The object isn't constant, but it is immutable because it's data is the file name and not the contents of the file.

I'd be breaking immutability if I added a `setFilename` method that allowed you to change what file the object was pointing to.

## Zend Diactoros

The PSR-7 implementation that I typically use is [Zend Diactoros](https://github.com/zendframework/zend-diactoros) because it's what used by [Radar](https://github.com/radarphp/Radar.Project).

I was hoping to dig in and show how it actually is immutable, but I can't. Because it isn't. :-(

It could have been, but the [Stream::attach method](https://github.com/zendframework/zend-diactoros/blob/master/src/Stream.php#L81-L93) makes it mutable.

The strange thing is that it implements [Psr\Http\Message\StreamInterface](https://github.com/php-fig/http-message/blob/master/src/StreamInterface.php) which does not define an attach method.

So `Zend\Diactoros\Stream` chooses to define additional methods that are not part of the PSR-7 interface, and in doing so, breaks immutability.

## Guzzle PSR-7

Looking at other implementations, it would appear [Guzzle PSR-7 streams](https://github.com/guzzle/psr7/blob/master/src/Stream.php) are immutable.

